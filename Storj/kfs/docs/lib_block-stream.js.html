<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: lib/block-stream.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: lib/block-stream.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';

const {Transform: TransformStream} = require('readable-stream');
const constants = require('./constants');
const merge = require('merge');


/**
 * Transforms the input stream into an output stream of N-sized chunks
 */
class BlockStream extends TransformStream {

  static get DEFAULTS() {
    return {
      chunkSize: constants.C,
      padLastChunk: false
    };
  }

  /**
   * @constructor
   * @param {Object} [options]
   * @param {Number} [options.chunkSize=constants.C] - The bytes of each chunk
   * @param {Boolean} [options.padLastChunk=false] - Pad last chunk with zeros
   */
  constructor(options) {
    super();
    options = merge(BlockStream.DEFAULTS, options);
    this._chunkSize = options.chunkSize;
    this._addPadding = options.padLastChunk;
    this._currentBuffer = new Buffer([]);
  }

  /**
   * Triggered when data is available
   * @event BlockStream#data
   * @param {Buffer} chunk
   */

  /**
   * Triggered when the stream is ended
   * @event BlockStream#end
   */

  /**
   * Implements the transform method
   * @private
   */
  _transform(bytes, encoding, callback) {
    this._addToBuffer(bytes);
    this._drainInternalBuffer();
    callback(null);
  }

  /**
   * Implements the flush method
   * @private
   */
  _flush(callback) {
    if (this._currentBuffer.length === 0) {
      return callback(null);
    }

    if (this._addPadding) {
      this._addToBuffer(
        Buffer(this._chunkSize - this._currentBuffer.length).fill(0)
      );
    }

    this.push(this._currentBuffer);
    this._currentBuffer = Buffer([]);
    callback(null);
  }

  /**
   * Drains the internal buffer
   * @private
   */
  _drainInternalBuffer() {
    if (this._currentBuffer.length &lt; this._chunkSize) {
      return;
    }

    var fullSlices = Math.floor(this._currentBuffer.length / this._chunkSize);
    var pushSlices = 0;

    while (pushSlices &lt; fullSlices) {
      this.push(this._currentBuffer.slice(0, this._chunkSize));
      this._currentBuffer = this._currentBuffer.slice(this._chunkSize);
      pushSlices++;
    }
  }

  /**
   * Adds the bytes to the internal buffer
   * @private
   */
  _addToBuffer(bytes) {
    this._currentBuffer = Buffer.concat([this._currentBuffer, bytes]);
  }

}

module.exports = BlockStream;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-kfs.html">kfs</a></li><li><a href="module-kfs_constants.html">kfs/constants</a></li><li><a href="module-kfs_utils.html">kfs/utils</a></li></ul><h3>Classes</h3><ul><li><a href="BlockStream.html">BlockStream</a></li><li><a href="Btable.html">Btable</a></li><li><a href="ReadableFileStream.html">ReadableFileStream</a></li><li><a href="Sbucket.html">Sbucket</a></li><li><a href="WritableFileStream.html">WritableFileStream</a></li></ul><h3>Events</h3><ul><li><a href="BlockStream.html#event:data">data</a></li><li><a href="BlockStream.html#event:end">end</a></li><li><a href="ReadableFileStream.html#event:data">data</a></li><li><a href="ReadableFileStream.html#event:end">end</a></li><li><a href="ReadableFileStream.html#event:error">error</a></li><li><a href="ReadableFileStream.html#event:readable">readable</a></li><li><a href="Sbucket.html#event:close">close</a></li><li><a href="Sbucket.html#event:idle">idle</a></li><li><a href="Sbucket.html#event:locked">locked</a></li><li><a href="Sbucket.html#event:open">open</a></li><li><a href="Sbucket.html#event:unlocked">unlocked</a></li><li><a href="WritableFileStream.html#event:error">error</a></li><li><a href="WritableFileStream.html#event:finish">finish</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-about.html">Motivation and Mechanics</a></li><li><a href="tutorial-cli.html">Command Line Interface</a></li><li><a href="tutorial-kfs.html">Programmatic Usage</a></li><li><a href="tutorial-performance-testing.html">Performance Testing the Changes</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Sat Nov 09 2024 15:21:40 GMT-0800 (Pacific Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
